# Управление пользователями

## Описание
Система управления пользователями с ролевым доступом.

## Аутентификация
- Доступ к CRM возможен только для авторизованных пользователей (`auth` middleware).
- Гостям доступны маршруты `GET /login`, `POST /login`.
- Восстановление пароля через форму недоступно — доступ выдает администратор.
- Повторные неудачные попытки входа ограничиваются rate-limiter'ом (5 попыток с блокировкой на 60 секунд).
- Форма входа требует валидный email и пароль.
- Выход выполняется через `POST /logout`, который завершает сессию и аннулирует токен.

## Первичный запуск системы
- При отсутствии записей в таблице `users` система автоматически перенаправляет на `GET /install/super-admin`.
- На этой странице создаётся первый пользователь с ролью `super_admin`.
- После успешного создания супер-админа система кэширует факт установки и больше не выполняет дополнительные проверки при запросах.

## Роли пользователей

### `super_admin` - Супер-администратор
Главный администратор системы (владелец сайта):
- Полный доступ ко всем компаниям
- Может редактировать любые данные
- Видит все логины и пароли
- Управляет пользователями
- Назначает модераторов
- Управляет правами доступа

### `moderator` - Модератор
Пользователь, закрепленный за конкретными компаниями:
- Видит и редактирует только свои компании
- Видит логины/пароли своих компаний
- Добавляет и редактирует банковские счета
- Управляет учетными данными своих компаний
- НЕ может назначать доступы другим пользователям

### `viewer` - Пользователь с доступом на просмотр
Базовая роль пользователя:
- Может получить доступ к конкретным компаниям
- Тип доступа определяется через `company_user_access`:
  - `view` - только просмотр реквизитов (без логинов/паролей)
  - `edit` - полный доступ к данным компании

## Структура БД

### Таблица `users`
- `id` - ID пользователя
- `name` - Имя пользователя
- `email` - Email (уникальный)
- `password` - Хешированный пароль
- `role` - Роль: `super_admin`, `moderator`, `viewer`
- `phone` - Телефон
- `operator` - Оператор связи (МТС, Билайн, Мегафон и т.д.)
- `phone_comment` - Комментарий к телефону (любая дополнительная информация)
- `telegram` - Telegram
- `whatsapp` - WhatsApp
- `created_at`, `updated_at` - Временные метки

### Таблица `phone_contacts`
- `id` - ID записи
- `name` - ФИО или название контакта
- `phone` - Номер телефона (строка до 64 символов)
- `operator` - Оператор связи (строка до 50 символов, опционально)
- `comment` - Дополнительная информация
- `created_at`, `updated_at` - Временные метки

## Модель User

### Методы
- `isSuperAdmin()` - Проверка роли супер-админа
- `moderatedCompanies()` - Компании, которые модерирует
- `accessibleCompanies()` - Компании с дополнительным доступом
- `allAccessibleCompanies()` - Все доступные компании (модерируемые + с доступом)

### Связи
- `moderatedCompanies` - HasMany - компании как модератор
- `accessibleCompanies` - BelongsToMany - компании через таблицу доступа

## Модель PhoneContact

- `fillable`: `name`, `phone`, `operator`, `comment`
- Используется для хранения независимых телефонных контактов
- Не связана с `users`, поэтому изменения не влияют на учетные записи

## Права доступа к компаниям

### Модератор компании
Назначается при создании/редактировании компании в поле `moderator_id`.

**Права:**
- Полный доступ к данным компании
- Видит логины и пароли
- Редактирует все данные

### Дополнительный доступ
Настраивается через таблицу `company_user_access`.

**Типы доступа:**

#### `view` - Просмотр
- Видит только реквизиты компании
- Видит блок «Доступ к онлайн-банку» (логин, пароль, ссылки) в режиме чтения
- НЕ может редактировать

#### `edit` - Редактирование
- Полный доступ к компании
- Видит логины/пароли
- Может редактировать все данные
- Может добавлять счета

**UI-поток:** на странице компании администратор нажимает «Добавить модератора», выбирает пользователя и тип (полный доступ или только чтение). Форма валидируется через `StoreCompanyAccessRequest`; при повторном отправлении значения сохраняются валидацией Laravel.

## Контроллеры

### UserController
- `index()` — Список пользователей с фильтрацией по ролям и контактам (требуется разрешение `users.view` или `users.manage`)
- `create()` — Форма создания пользователя с выбором роли (разрешения `users.create` или `users.manage`)
- `store()` — Сохранение нового пользователя с назначением роли
- `edit()` — Полноценная форма редактирования профиля пользователя (разрешения `users.edit` или `users.manage`)
- `update()` — Обновление учетных данных и RBAC-роли пользователя
- `updatePhone()` — Обновление телефонных данных пользователя (разрешения `users.edit` или `users.manage`)

### PhoneContactController
- `index()` — Просмотр и фильтрация телефонного справочника (разрешения `user-phones.view` или `user-phones.manage`)
- `store()` — Создание новой записи справочника (разрешения `user-phones.create` или `user-phones.manage`)
- `update()` — Редактирование существующей записи (разрешения `user-phones.edit` или `user-phones.manage`)
- `destroy()` — Удаление записи (разрешения `user-phones.delete` или `user-phones.manage`)

#### Создание пользователя
При создании нового пользователя через `/admin/users/create`:
- **Обязательные поля:** имя, email, пароль (с подтверждением)
- **Необязательные поля:** телефон, оператор
- **Роль:** обязательно выбрать из списка активных RBAC-ролей (например, «Администратор», «Супер Администратор» и т.д.)
- Пароль автоматически хешируется перед сохранением
- Email проверяется на уникальность
- После создания пользователь появляется в списке `/admin/users`

#### Редактирование пользователя
Страница `/admin/users/{user}/edit` позволяет обновлять всю учетную запись:
- Доступны поля для изменения ФИО, email, телефона, оператора и комментария
- Роль выбирается из списка активных RBAC-ролей; изменение синхронизируется с legacy-значением `role`
- Пароль можно сменить при необходимости (поле необязательное, работает с подтверждением)
- После сохранения выводится уведомление и выполняется редирект на список пользователей

## Маршруты

```php
Route::middleware('guest')->group(function () {
    Route::get('/login', [AuthenticatedSessionController::class, 'create']);
    Route::post('/login', [AuthenticatedSessionController::class, 'store']);
});

Route::post('/logout', [AuthenticatedSessionController::class, 'destroy'])
    ->middleware('auth');

Route::prefix('admin')->middleware('auth')->group(function () {
    Route::get('/users', [UserController::class, 'index']); // permission: users.view|users.manage
    Route::get('/users/phones', [PhoneContactController::class, 'index']); // permission: user-phones.view|user-phones.manage
    Route::post('/users/phones', [PhoneContactController::class, 'store']); // permission: user-phones.create|user-phones.manage
    Route::put('/users/phones/{phoneContact}', [PhoneContactController::class, 'update']); // permission: user-phones.edit|user-phones.manage
    Route::delete('/users/phones/{phoneContact}', [PhoneContactController::class, 'destroy']); // permission: user-phones.delete|user-phones.manage
    Route::get('/users/create', [UserController::class, 'create']); // permission: users.create|users.manage
    Route::post('/users', [UserController::class, 'store']); // permission: users.create|users.manage
    Route::get('/users/{user}/edit', [UserController::class, 'edit']); // permission: users.edit|users.manage
    Route::put('/users/{user}', [UserController::class, 'update']); // permission: users.edit|users.manage
});
```

## Представления

- `admin/users/index.blade.php` - Список пользователей
- `admin/users/create.blade.php` - Форма создания
- `admin/users/phones/index.blade.php` - Телефонный справочник (независимые контакты)

## Навигация пользователей

- В боковом меню административной панели отображается раздел «Мои компании»
- Список включает компании, где пользователь назначен модератором или имеет доступ через `company_user_access`
- При отсутствии закрепленных компаний выводится уведомление в меню

## Профиль модератора

Модератор может указать свои контакты:
- Телефон
- Telegram
- WhatsApp
- Email
- Пароль от почты (сохраняется в профиле)

Эти данные доступны для связи с модератором по вопросам компаний.

## Примеры использования

### Назначить модератора компании
При создании/редактировании компании выбрать пользователя с ролью `moderator` или `super_admin`.

### Дать доступ на просмотр
1. Открыть компанию
2. Вкладка "Доступ"
3. Добавить пользователя с типом `view`

### Дать доступ на редактирование
1. Открыть компанию
2. Вкладка "Доступ"
3. Добавить пользователя с типом `edit`

## Управление телефонными данными

### Просмотр телефонных данных
На странице списка пользователей (`/admin/users`) отображается:
- **Оператор** - в виде цветного бейджа рядом с номером
- **Номер телефона** - кликабельная ссылка для набора
- **Комментарий** - краткий текст с полной версией в tooltip при наведении

### Редактирование телефонных данных
Редактировать телефонные данные пользователей могут все, у кого есть разрешение `users.edit` или `users.manage`:

1. На странице списка пользователей нажать кнопку редактирования телефона
2. В модальном окне доступны поля:
   - **Оператор** - название мобильного оператора (МТС, Билайн, Мегафон)
   - **Номер телефона** - контактный номер
   - **Комментарий** - любая дополнительная информация (время работы, дополнительные контакты и т.д.)
3. Все поля опциональные
4. После сохранения данные отображаются в таблице

### Маршруты
```php
Route::put('/users/{user}/phone', [UserController::class, 'updatePhone'])->name('users.update-phone');
```

### Валидация
- `phone` - строка, максимум 64 символа
- `operator` - строка, максимум 50 символов
- `phone_comment` - текст без ограничений

## Телефонный справочник

- Маршрут: `GET /admin/users/phones`
- Доступ: пользователи с разрешением `user-phones.view` или `user-phones.manage`
- Функциональность:
  - Фильтрация по ФИО, номеру телефона, оператору, а также по тексту комментариев
  - Просмотр полей: ФИО, оператор, телефон, комментарий, дата обновления
  - Offcanvas-панели для создания и редактирования
  - Поддержка подсказок операторов через `<datalist>`
- После сохранения/удаления данных выполняется возврат на страницу справочника.
- Данные справочника не связаны с моделью `User` и используются как независимая контактная база.

### UI особенности

- Таблица адаптируется под небольшие экраны, комментарий обрезается до 100 символов
- Пустые значения заменяются символом `—`
- Отображается уведомление об отсутствии данных
- Всплывающее уведомление после сохранения данных

## Изменения (версии)

### 2025-11-13 (Обновление 7)
- **Редактирование пользователя:** страница `/admin/users/{user}/edit` теперь позволяет менять ФИО, email, контакты, роль и пароль пользователя в одной форме
- **Валидация:** `UpdateUserRequest` нормализует значения телефонов, проверяет уникальность email и требования к новому паролю
- **Сервисный слой:** обновление вынесено в `UserService` и обернуто транзакцией для согласованного применения изменений

### 2025-11-13 (Обновление 6)
- **Назначение ролей:** при создании и редактировании пользователей требуется выбрать роль из доступных RBAC-групп
- **Список пользователей:** фильтрация и отображение ролей основаны на RBAC; добавлена кнопка быстрого перехода к редактированию роли

### 2025-11-13 (Обновление 5)
- **Телефонный справочник:** переход на систему разрешений `user-phones.*`, скрытие кнопок в UI при отсутствии прав
- **Редактирование телефонных данных:** теперь управляется разрешениями `users.edit`/`users.manage`
- **Документация:** обновлены разделы по контроллерам, маршрутам и правам

### 2025-11-13 (Обновление 4)
- **Телефонный справочник:** вынесен в отдельную сущность `phone_contacts`
- Добавлены CRUD-маршруты и контроллер `PhoneContactController`
- Страница `Телефоны` теперь отображает независимые контакты, не связанные с пользователями
- Реализованы offcanvas для создания, редактирования и удаление записей
- Обновлены переводы и документация

### 2025-11-13 (Обновление 3)
- **Раздел «Телефоны»:**
  - Добавлен маршрут `GET /admin/users/phones` с доступом только для супер-админа
  - Создан телефонный справочник с фильтрами и пагинацией
  - Реализована панель Offcanvas для редактирования оператора, номера, ФИО и комментария
  - Добавлен datalist с подсказками операторов
  - Сообщения об успешном сохранении теперь отображаются на странице справочника

### 2025-11-13 (Обновление 2)
- **Добавлено управление телефонными данными:**
  - Добавлено поле `phone_comment` в таблицу `users`
  - Добавлена возможность редактирования телефонов только для супер-админа
  - Создано модальное окно для редактирования оператора, номера и комментария
  - Добавлен вывод телефонных данных в списке пользователей
  - Комментарии отображаются с сокращением и полным текстом в tooltip

### 2025-11-13
- **Упрощена форма создания пользователя:** удалены поля выбора ролей из HTML-формы
- **Автоматическое назначение роли:** новым пользователям автоматически назначается роль `viewer`
- **Отложенное назначение RBAC ролей:** RBAC роли больше не выбираются при создании, могут быть назначены позже
- **Обновлена валидация:** удалена обязательная валидация поля `role` в форме создания
- **Упрощен контроллер:** удалена зависимость от модели `Role` в методе `create()`

### 2025-11-12
- Добавлена обязательная аутентификация для доступа к CRM.
- Реализована форма входа на шаблоне Vuexy.
- Внедрён rate-limiter для предотвращения подбора паролей.
- Добавлен раздел «Мои компании» в боковом меню с отображением закрепленных компаний пользователя.

### 2025-11-11
- Добавлены роли `super_admin`, `moderator`, `viewer`
- Добавлена система прав доступа к компаниям
- Добавлены поля контактов: phone, telegram, whatsapp
- Реализована связь пользователей с компаниями
