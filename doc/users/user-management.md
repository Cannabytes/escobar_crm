# Управление пользователями

## Описание
Система управления пользователями с ролевым доступом.

## Аутентификация
- Доступ к CRM возможен только для авторизованных пользователей (`auth` middleware).
- Гостям доступны маршруты `GET /login`, `POST /login`, `GET /register`, `POST /register`.
- После успешной регистрации пользователь автоматически авторизуется и перенаправляется в админ-панель.
- Повторные неудачные попытки входа ограничиваются rate-limiter'ом (5 попыток с блокировкой на 60 секунд).
- На форме регистрации обязательна отметка согласия с политикой обработки данных (`terms`).
- Выход выполняется через `POST /logout`, который завершает сессию и аннулирует токен.

## Первичный запуск системы
- При отсутствии записей в таблице `users` система автоматически перенаправляет на `GET /install/super-admin`.
- На этой странице создаётся первый пользователь с ролью `super_admin`.
- После успешного создания супер-админа система кэширует факт установки и больше не выполняет дополнительные проверки при запросах.

## Роли пользователей

### `super_admin` - Супер-администратор
Главный администратор системы (владелец сайта):
- Полный доступ ко всем компаниям
- Может редактировать любые данные
- Видит все логины и пароли
- Управляет пользователями
- Назначает модераторов
- Управляет правами доступа

### `moderator` - Модератор
Пользователь, закрепленный за конкретными компаниями:
- Видит и редактирует только свои компании
- Видит логины/пароли своих компаний
- Добавляет и редактирует банковские счета
- Управляет учетными данными своих компаний
- НЕ может назначать доступы другим пользователям

### `viewer` - Пользователь с доступом на просмотр
Базовая роль пользователя:
- Может получить доступ к конкретным компаниям
- Тип доступа определяется через `company_user_access`:
  - `view` - только просмотр реквизитов (без логинов/паролей)
  - `edit` - полный доступ к данным компании

## Структура БД

### Таблица `users`
- `id` - ID пользователя
- `name` - Имя пользователя
- `email` - Email (уникальный)
- `password` - Хешированный пароль
- `role` - Роль: `super_admin`, `moderator`, `viewer`
- `phone` - Телефон
- `telegram` - Telegram
- `whatsapp` - WhatsApp
- `created_at`, `updated_at` - Временные метки

## Модель User

### Методы
- `isSuperAdmin()` - Проверка роли супер-админа
- `moderatedCompanies()` - Компании, которые модерирует
- `accessibleCompanies()` - Компании с дополнительным доступом
- `allAccessibleCompanies()` - Все доступные компании (модерируемые + с доступом)

### Связи
- `moderatedCompanies` - HasMany - компании как модератор
- `accessibleCompanies` - BelongsToMany - компании через таблицу доступа

## Права доступа к компаниям

### Модератор компании
Назначается при создании/редактировании компании в поле `moderator_id`.

**Права:**
- Полный доступ к данным компании
- Видит логины и пароли
- Редактирует все данные

### Дополнительный доступ
Настраивается через таблицу `company_user_access`.

**Типы доступа:**

#### `view` - Просмотр
- Видит только реквизиты компании
- НЕ видит логины/пароли
- НЕ может редактировать

#### `edit` - Редактирование
- Полный доступ к компании
- Видит логины/пароли
- Может редактировать все данные
- Может добавлять счета

## Контроллеры

### UserController
- `index()` - Список пользователей
- `create()` - Форма создания
- `store()` - Сохранение пользователя

## Маршруты

```php
Route::middleware('guest')->group(function () {
    Route::get('/login', [AuthenticatedSessionController::class, 'create']);
    Route::post('/login', [AuthenticatedSessionController::class, 'store']);
    Route::get('/register', [RegisteredUserController::class, 'create']);
    Route::post('/register', [RegisteredUserController::class, 'store']);
});

Route::post('/logout', [AuthenticatedSessionController::class, 'destroy'])
    ->middleware('auth');

Route::prefix('admin')->middleware('auth')->group(function () {
    Route::get('/users', [UserController::class, 'index']);
    Route::get('/users/create', [UserController::class, 'create']);
    Route::post('/users', [UserController::class, 'store']);
});
```

## Представления

- `admin/users/index.blade.php` - Список пользователей
- `admin/users/create.blade.php` - Форма создания

## Навигация пользователей

- В боковом меню административной панели отображается раздел «Мои компании»
- Список включает компании, где пользователь назначен модератором или имеет доступ через `company_user_access`
- При отсутствии закрепленных компаний выводится уведомление в меню

## Профиль модератора

Модератор может указать свои контакты:
- Телефон
- Telegram
- WhatsApp
- Email
- Пароль от почты (сохраняется в профиле)

Эти данные доступны для связи с модератором по вопросам компаний.

## Примеры использования

### Назначить модератора компании
При создании/редактировании компании выбрать пользователя с ролью `moderator` или `super_admin`.

### Дать доступ на просмотр
1. Открыть компанию
2. Вкладка "Доступ"
3. Добавить пользователя с типом `view`

### Дать доступ на редактирование
1. Открыть компанию
2. Вкладка "Доступ"
3. Добавить пользователя с типом `edit`

## Изменения (версии)

### 2025-11-12
- Добавлена обязательная аутентификация для доступа к CRM.
- Реализованы формы входа/регистрации на шаблоне Vuexy.
- Внедрён rate-limiter для предотвращения подбора паролей.
- Добавлен раздел «Мои компании» в боковом меню с отображением закрепленных компаний пользователя.

### 2025-11-11
- Добавлены роли `super_admin`, `moderator`, `viewer`
- Добавлена система прав доступа к компаниям
- Добавлены поля контактов: phone, telegram, whatsapp
- Реализована связь пользователей с компаниями
