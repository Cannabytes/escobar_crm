# Управление компаниями

## Описание
Система управления компаниями аудиторской конторы с гибкими правами доступа.

## Структура БД

### Таблица `companies`
Основная информация о компаниях:
- `id` - ID компании
- `name` - Название компании
- `country` - Страна регистрации
- `moderator_id` - ID модератора компании (FK на users)
- `license_file` - Путь к файлу лицензии
- `created_at`, `updated_at` - Временные метки

### Таблица `company_credentials`
Конфиденциальные учетные данные (логины/пароли):
- `id` - ID записи
- `company_id` - ID компании (FK)
- `login` - Логин
- `login_id` - ID логина
- `password` - Пароль
- `email` - Email
- `email_password` - Пароль от email
- `online_banking_url` - Ссылка на онлайн-банкинг
- `manager_name` - Имя менеджера
- `manager_phone` - Телефон менеджера

**Доступ:** Только модератор компании и супер-админ

### Таблица `company_bank_accounts`
Банковские реквизиты компании:
- `id` - ID счета
- `company_id` - ID компании (FK)
- `bank_name` - Название банка
- `country` - Страна
- `company_name` - Название компании в банке
- `currency` - Валюта счета
- `account_number` - Номер счета
- `iban` - IBAN
- `swift` - SWIFT код
- `sort_order` - Порядок сортировки

**Доступ:** Все пользователи с доступом к компании

### Таблица `company_user_access`
Права доступа пользователей к компаниям:
- `id` - ID записи
- `company_id` - ID компании (FK)
- `user_id` - ID пользователя (FK)
- `access_type` - Тип доступа: `view` (просмотр) или `edit` (редактирование)

## Модели

### Company
Модель компании с методами проверки прав:
- `canUserEdit(User $user)` - Может ли пользователь редактировать
- `canUserView(User $user)` - Может ли пользователь просматривать
- `canUserViewCredentials(User $user)` - Может ли видеть логины/пароли

Связи:
- `moderator()` - Модератор компании
- `bankAccounts()` - Банковские счета
- `credentials()` - Учетные данные
- `accessUsers()` - Пользователи с доступом

### CompanyBankAccount
Модель банковского счета.

### CompanyCredential
Модель учетных данных (логины/пароли).

### CompanyAccess
Модель доступа пользователя к компании.

## Роли и права доступа

### Супер-администратор (`super_admin`)
- Видит все компании
- Редактирует любые данные
- Видит логины/пароли всех компаний
- Управляет доступами

### Модератор компании
- Видит и редактирует свои компании
- Видит логины/пароли своих компаний
- Может добавлять банковские счета
- НЕ может управлять доступами (только админ)

### Пользователь с правом `edit`
- Может редактировать данные компании
- Видит логины/пароли
- Может добавлять банковские счета

### Пользователь с правом `view`
- Может только просматривать реквизиты
- НЕ видит логины/пароли
- НЕ может редактировать

## Контроллеры

### CompanyController
Основной контроллер управления компаниями:
- `index()` - Список компаний
- `create()` - Форма создания
- `store()` - Сохранение новой компании
- `show()` - Просмотр компании
- `edit()` - Форма редактирования
- `update()` - Обновление данных
- `destroy()` - Удаление компании

### CompanyBankAccountController
Управление банковскими счетами:
- `store()` - Добавить счет
- `update()` - Обновить счет
- `destroy()` - Удалить счет

### CompanyCredentialController
Управление учетными данными:
- `store()` - Сохранить/обновить учетные данные

### CompanyAccessController
Управление доступами:
- `store()` - Добавить доступ пользователю
- `destroy()` - Удалить доступ

## Маршруты

```php
Route::resource('companies', CompanyController::class);
Route::post('companies/{company}/bank-accounts', [CompanyBankAccountController::class, 'store']);
Route::post('companies/{company}/credentials', [CompanyCredentialController::class, 'store']);
Route::post('companies/{company}/access', [CompanyAccessController::class, 'store']);
```

## Представления

- `admin/companies/index.blade.php` - Список компаний
- `admin/companies/create.blade.php` - Форма создания
- `admin/companies/show.blade.php` - Просмотр с вкладками
- `admin/companies/edit.blade.php` - Редактирование

## Особенности

1. **Загрузка лицензий**: Файлы хранятся в `storage/app/public/licenses/`
2. **Вкладки на странице компании**:
   - Логины и пароли (конфиденциально)
   - Реквизиты (для всех с доступом)
   - Управление доступом
3. **Модальные окна**: Добавление счетов и доступов через модальные окна
4. **Валидация**: Все формы валидируются на стороне сервера и клиента
