# Система управления ролями и правами доступа (RBAC)

## Обзор

Система управления ролями и правами доступа (Role-Based Access Control, RBAC) позволяет супер-администратору гибко настраивать права доступа пользователей через создание ролей с индивидуальными наборами разрешений.

## Основные компоненты

### 1. Группы разрешений (Permission Groups)
Группы объединяют логически связанные разрешения для удобства управления:
- Компании
- Лицензии компаний
- Банковские счета компаний
- Учётные данные компаний
- Доступ пользователей к компаниям
- Пользователи
- Роли и разрешения
- Логи активности
- Настройки системы
- Профиль

### 2. Разрешения (Permissions)
Каждое разрешение имеет тип операции:
- **view** — Просмотр данных
- **create** — Создание новых записей
- **edit** — Редактирование существующих записей
- **delete** — Удаление записей
- **manage** — Полное управление (все операции)

### 3. Роли (Roles)
Роли объединяют набор разрешений, которые назначаются пользователям.

#### Системные роли (нельзя удалить):
- **Супер Администратор** (`super_admin`) — полный доступ ко всем функциям автоматически
- **Администратор** (`admin`) — управление всеми разделами, кроме ролей и логов

#### Предустановленные пользовательские роли:
- **Модератор компаний** (`company_moderator`) — управление компаниями и их данными
- **Наблюдатель** (`viewer`) — только просмотр компаний и банковских счетов
- **Менеджер пользователей** (`user_manager`) — управление пользователями и их доступами

## Установка и настройка

### 1. Выполнение миграций

```bash
php artisan migrate
```

Будут созданы следующие таблицы:
- `permission_groups` — группы разрешений
- `permissions` — разрешения
- `roles` — роли
- `role_permissions` — связь ролей и разрешений
- Обновление `users` — добавление поля `role_id`

### 2. Заполнение базовых данных

```bash
php artisan db:seed --class=PermissionSeeder
php artisan db:seed --class=RoleSeeder
```

## Использование

### Управление ролями

#### Доступ к разделу управления ролями
Перейдите в **Система → Роли и права** (доступно только супер-администратору).

#### Создание новой роли

1. Нажмите кнопку **"Создать роль"**
2. Заполните форму:
   - **Название роли** — понятное название (например: "Менеджер продаж")
   - **Slug** — уникальный идентификатор (генерируется автоматически из названия)
   - **Описание** — краткое описание назначения роли
   - **Активная роль** — включить/выключить роль
3. Выберите разрешения:
   - Разрешения сгруппированы по функциональным разделам
   - Каждое разрешение имеет тип (просмотр, создание, редактирование и т.д.)
   - Можно выбрать любую комбинацию разрешений
4. Нажмите **"Создать роль"**

#### Редактирование роли

1. В списке ролей нажмите **"Редактировать"** на нужной роли
2. Измените название, описание или набор разрешений
3. Нажмите **"Сохранить изменения"**

**Примечание**: Системные роли можно редактировать только частично (разрешения), остальные поля защищены.

#### Удаление роли

Роль можно удалить только если:
- Она не является системной
- Ей не назначены пользователи

### Назначение ролей пользователям

При создании или редактировании пользователя:
1. В форме пользователя выберите **"Роль в системе (RBAC)"**
2. Выберите нужную роль из списка
3. Сохраните изменения

**Примечание**: Старая система ролей (`role`) остаётся для обратной совместимости, но рекомендуется использовать новую RBAC систему (`role_id`).

## Проверка прав доступа

### В контроллерах

```php
// Проверка наличия разрешения
if (auth()->user()->hasPermission('companies.create')) {
    // Разрешено создавать компании
}

// Проверка наличия любого из разрешений
if (auth()->user()->hasAnyPermission(['companies.edit', 'companies.manage'])) {
    // Разрешено редактирование или полное управление
}

// Проверка наличия всех разрешений
if (auth()->user()->hasAllPermissions(['companies.view', 'companies.edit'])) {
    // Есть оба разрешения
}
```

### Использование middleware

В роутах можно использовать middleware для защиты:

```php
// Требуется любое из указанных разрешений
Route::get('/companies', [CompanyController::class, 'index'])
    ->middleware('permission:companies.view,companies.manage');

// Требуются ВСЕ указанные разрешения
Route::post('/companies', [CompanyController::class, 'store'])
    ->middleware('permission.all:companies.create,companies.manage');
```

### В Blade шаблонах

```blade
@if(auth()->user()->hasPermission('companies.create'))
    <a href="{{ route('admin.companies.create') }}" class="btn btn-primary">
        Создать компанию
    </a>
@endif

@if(auth()->user()->hasAnyPermission(['users.view', 'users.manage']))
    <li class="menu-item">
        <a href="{{ route('admin.users.index') }}">Пользователи</a>
    </li>
@endif
```

## Архитектура и структура кода

### Модели

- **Role** (`App\Models\Role`) — модель роли
- **Permission** (`App\Models\Permission`) — модель разрешения
- **PermissionGroup** (`App\Models\PermissionGroup`) — модель группы разрешений

### Сервисы

- **RoleService** (`App\Services\RoleService`) — бизнес-логика работы с ролями
  - `getAllRoles()` — получить все роли
  - `createRole(array $data)` — создать роль
  - `updateRole(Role $role, array $data)` — обновить роль
  - `deleteRole(Role $role)` — удалить роль
  - `cloneRole(Role $role, string $newName)` — клонировать роль

- **PermissionService** (`App\Services\PermissionService`) — работа с разрешениями
  - `getAllGroupedPermissions()` — получить разрешения, сгруппированные по группам
  - `getPermissionsForForm()` — подготовить данные для форм

### Контроллеры

- **RoleController** (`App\Http\Controllers\Admin\RoleController`) — CRUD операции с ролями

### Middleware

- **CheckPermission** (`App\Http\Middleware\CheckPermission`) — проверка наличия любого из указанных разрешений
- **CheckAllPermissions** (`App\Http\Middleware\CheckAllPermissions`) — проверка наличия всех указанных разрешений

### FormRequests

- **StoreRoleRequest** — валидация при создании роли
- **UpdateRoleRequest** — валидация при обновлении роли

## Список всех разрешений

### Компании
- `companies.view` — Просмотр списка компаний
- `companies.show` — Просмотр карточки компании
- `companies.create` — Создание компании
- `companies.edit` — Редактирование компании
- `companies.delete` — Удаление компании
- `companies.manage` — Полное управление компаниями

### Лицензии компаний
- `company-licenses.view` — Просмотр лицензий
- `company-licenses.edit` — Редактирование лицензий

### Банковские счета компаний
- `company-bank-accounts.view` — Просмотр банковских счетов
- `company-bank-accounts.create` — Создание банковских счетов
- `company-bank-accounts.edit` — Редактирование банковских счетов
- `company-bank-accounts.delete` — Удаление банковских счетов

### Учётные данные компаний
- `company-credentials.view` — Просмотр учётных данных
- `company-credentials.create` — Создание учётных данных
- `company-credentials.edit` — Редактирование учётных данных
- `company-credentials.delete` — Удаление учётных данных

### Доступ пользователей к компаниям
- `company-access.view` — Просмотр доступа
- `company-access.create` — Предоставление доступа
- `company-access.delete` — Удаление доступа

### Пользователи
- `users.view` — Просмотр списка пользователей
- `users.show` — Просмотр профиля пользователя
- `users.create` — Создание пользователя
- `users.edit` — Редактирование пользователя
- `users.delete` — Удаление пользователя
- `users.manage` — Полное управление пользователями

### Роли и разрешения
- `roles.view` — Просмотр списка ролей
- `roles.show` — Просмотр роли
- `roles.create` — Создание роли
- `roles.edit` — Редактирование роли
- `roles.delete` — Удаление роли
- `roles.manage` — Полное управление ролями

### Логи активности
- `logs.view` — Просмотр логов активности
- `logs.show` — Просмотр деталей лога

### Настройки системы
- `settings.view` — Просмотр настроек (через модальное окно)
- `settings.edit` — Редактирование настроек (через модальное окно)

### Профиль
- `profile.view` — Просмотр собственного профиля
- `profile.edit` — Редактирование собственного профиля

## Лучшие практики

1. **Создавайте роли на основе должностей**, а не отдельных людей
2. **Используйте описательные названия** для ролей и разрешений
3. **Следуйте принципу минимальных привилегий** — давайте только необходимые права
4. **Регулярно проверяйте** назначенные роли и разрешения
5. **Документируйте** созданные роли и их предназначение
6. **Используйте группы разрешений** для логической организации
7. **Не удаляйте системные роли** — они необходимы для работы системы

## Troubleshooting

### Пользователь не видит разделы меню
- Убедитесь, что пользователю назначена роль через `role_id`
- Проверьте, что роль активна (`is_active = true`)
- Убедитесь, что у роли есть соответствующие разрешения

### Не удаётся удалить роль
- Проверьте, не является ли роль системной (`is_system = true`)
- Убедитесь, что роль не назначена ни одному пользователю

### Супер-администратор не видит раздел "Роли"
- Убедитесь, что выполнены все миграции
- Проверьте, что роуты зарегистрированы в `routes/web.php`
- Очистите кэш: `php artisan route:clear && php artisan view:clear`

## Безопасность

1. **Только супер-администратор** может управлять ролями
2. **Системные роли защищены** от изменения и удаления
3. **Slug ролей нельзя изменить** после создания
4. **Все проверки прав** выполняются на стороне сервера
5. **Middleware защищает** роуты от несанкционированного доступа

## Roadmap

Планируемые улучшения:
- [ ] Экспорт и импорт ролей
- [ ] История изменений ролей и разрешений
- [ ] Временные разрешения (с датой истечения)
- [ ] Наследование ролей
- [ ] API для управления ролями
- [ ] Массовое назначение ролей пользователям

