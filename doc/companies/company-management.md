# Управление компаниями

## Описание
Система управления компаниями аудиторской конторы с гибкими правами доступа.

## Структура БД

### Таблица `companies`
Основная информация о компаниях:
- `id` - ID компании
- `name` - Название компании
- `country` - Страна регистрации
- `moderator_id` - ID модератора компании (FK на users)
- `license_file` - Путь к файлу лицензии (УСТАРЕВШЕЕ, для обратной совместимости)
- `created_at`, `updated_at` - Временные метки

### Таблица `company_licenses` (НОВАЯ СТРУКТУРА)
Множественные лицензии компаний:
- `id` - ID лицензии
- `company_id` - ID компании (FK)
- `file_path` - Путь к файлу изображения лицензии
- `original_name` - Оригинальное название файла
- `sort_order` - Порядок сортировки
- `created_at`, `updated_at` - Временные метки

**Доступ:** Просмотр доступен всем пользователям с доступом к компании  
**Редактирование:** Супер-админ, главный модератор и пользователи с правом `edit`

### Таблица `company_bank_accounts` (СТАРАЯ СТРУКТУРА)
Банковские реквизиты компании (используется для обратной совместимости):
- `id` - ID счета
- `company_id` - ID компании (FK)
- `bank_name` - Название банка
- `country` - Страна
- `company_name` - Название компании в банке
- `currency` - Валюта счета
- `account_number` - Номер счета
- `iban` - IBAN
- `swift` - SWIFT код
- `sort_order` - Порядок сортировки

**Доступ:** Все пользователи с доступом к компании

### Таблица `banks` (НОВАЯ СТРУКТУРА)
Информация о банках компании:
- `id` - ID банка
- `company_id` - ID компании (FK)
- `name` - Название банка (Монобанк, ПриватБанк и т.д.)
- `country` - Страна банка
- `bank_code` - Код банка (MFI, SWIFT и т.д.)
- `notes` - Дополнительные примечания
- `login`, `login_id` - Авторизационные данные
- `password` - Пароль для входа
- `email`, `email_password` - Почтовый ящик и пароль
- `online_banking_url` - URL интернет-банкинга
- `manager_name`, `manager_phone` - Контакт менеджера
- `sort_order` - Порядок сортировки
- `created_at`, `updated_at` - Временные метки

**Доступ к реквизитам:** Все пользователи с доступом к компании  
**Редактирование банка и чувствительных данных:** Супер-админ, главный модератор и пользователи с правом `edit` на уровне компании

### Таблица `bank_details` (НОВАЯ СТРУКТУРА)
Реквизиты банков (один банк может иметь несколько реквизитов):
- `id` - ID реквизита
- `bank_id` - ID банка (FK)
- `detail_type` - Тип реквизита: `account_number`, `iban`, `swift`, `recipient_name`, `recipient_address`, `bank_address`, `reference_code`, `custom`
- `detail_key` - Ключ/название реквизита (напр. "Счет", "Получатель", "Адрес")
- `detail_value` - Значение реквизита
- `currency` - Валюта (опционально, для счетов)
- `notes` - Примечания
- `is_primary` - Является ли основным реквизитом (boolean)
- `sort_order` - Порядок сортировки
- `created_at`, `updated_at` - Временные метки

**Доступ:** 
- Просмотр: Все пользователи с доступом к компании
- Редактирование: Модератор и пользователи с правом `edit`

### Таблица `company_user_access`
Права доступа пользователей к компаниям:
- `id` - ID записи
- `company_id` - ID компании (FK)
- `user_id` - ID пользователя (FK)
- `access_type` - Тип доступа: `view` (просмотр) или `edit` (редактирование)

## Модели

### Company
Модель компании с методами проверки прав:
- `canUserEdit(User $user)` - Может ли пользователь редактировать
- `canUserView(User $user)` - Может ли пользователь просматривать

Связи:
- `moderator()` - Модератор компании
- `bankAccounts()` - Банковские счета (старая структура)
- `banks()` - Банки (новая структура)
- `licenses()` - Лицензии компании (множественные изображения)
- `accessUsers()` - Пользователи с доступом

### CompanyLicense
Модель лицензии компании. Хранит информацию о загруженных изображениях лицензий.

Методы:
- `getFileUrlAttribute()` - Получить URL файла лицензии для отображения

Связи:
- `company()` - Компания, к которой принадлежит лицензия

### Bank
Модель банка компании. Каждый банк может содержать несколько реквизитов и хранит авторизационные данные.

Методы:
- `details()` - Получить реквизиты банка
- `userCanManage(User $user)` - Проверить право пользователя на управление банком

### BankDetail
Модель реквизита банка. Хранит информацию о конкретных реквизитах (счета, IBAN, SWIFT и т.д.).

Константы типов:
- `TYPE_ACCOUNT_NUMBER` - Номер счета
- `TYPE_IBAN` - IBAN
- `TYPE_SWIFT` - SWIFT код
- `TYPE_RECIPIENT_NAME` - Имя получателя
- `TYPE_RECIPIENT_ADDRESS` - Адрес получателя
- `TYPE_BANK_ADDRESS` - Адрес банка
- `TYPE_REFERENCE_CODE` - Код ссылки
- `TYPE_CUSTOM` - Пользовательский тип

Методы:
- `getTypes()` - Получить все доступные типы реквизитов

### CompanyBankAccount
Модель банковского счета (старая структура для обратной совместимости).

### CompanyAccess
Модель доступа пользователя к компании.

### Назначение дополнительных модераторов
- Страница `/admin/companies/{company}` содержит кнопку **«Добавить модератора»**, открывающую модальное окно.
- В модальном окне сначала выбирается свободный пользователь, затем уровень доступа:
  - **Полный доступ** (`access_type = edit`) — редактирование всех данных компании, включая лицензии и банковские реквизиты.
  - **Только чтение** (`access_type = view`) — просмотр карточки компании без возможности изменения.
- По умолчанию предлагается полный доступ; при повторном открытии модалки значения подтягиваются из предыдущего ввода.
- Запрос обрабатывается контроллером `CompanyAccessController@store`, который использует `StoreCompanyAccessRequest` для авторизации и валидации.

## Роли и права доступа

### Супер-администратор (`super_admin`)
- Видит все компании
- Редактирует любые данные
- Видит логины/пароли всех компаний
- Управляет доступами

### Модератор компании
- Видит и редактирует свои компании
- Видит логины/пароли своих компаний
- Может добавлять банковские счета
- НЕ может управлять доступами (только админ)

### Пользователь с правом `edit`
- Может редактировать данные компании
- Видит логины/пароли
- Может добавлять банковские счета

### Пользователь с правом `view`
- Может только просматривать реквизиты
- Видит блок «Доступ к онлайн-банку», но не может изменять значения
- НЕ может редактировать

## Контроллеры

### CompanyController
Основной контроллер управления компаниями:
- `index()` - Список компаний
- `create()` - Форма создания
- `store()` - Сохранение новой компании
- `show()` - Просмотр компании
- `edit()` - Форма редактирования
- `update()` - Обновление данных
- `destroy()` - Удаление компании

### CompanyBankAccountController (СТАРАЯ СТРУКТУРА)
Управление банковскими счетами (для обратной совместимости):
- `store()` - Добавить счет
- `update()` - Обновить счет
- `destroy()` - Удалить счет

### CompanyBankController (НОВАЯ СТРУКТУРА)
Управление банками компании:
- `store()` - Добавить новый банк
- `update()` - Обновить данные банка
- `destroy()` - Удалить банк (со всеми реквизитами)

### CompanyBankDetailController (НОВАЯ СТРУКТУРА)
Управление реквизитами банков:
- `store()` - Добавить реквизит для банка
- `update()` - Обновить реквизит
- `destroy()` - Удалить реквизит (поддерживает AJAX-запросы, возвращает JSON при AJAX-запросе)

### CompanyAccessController
Управление доступами:
- `store()` - Добавить доступ пользователю
- `destroy()` - Удалить доступ

### CompanyLicenseController (НОВАЯ СТРУКТУРА)
Управление лицензиями компании:
- `store()` - Загрузить новые лицензии (поддержка множественной загрузки)
- `destroy()` - Удалить лицензию (поддерживает AJAX-запросы, возвращает JSON при AJAX-запросе)

## Маршруты

### Управление компаниями
```php
Route::resource('companies', CompanyController::class);
```

### Старая структура банков (для совместимости)
```php
Route::post('companies/{company}/bank-accounts', [CompanyBankAccountController::class, 'store']);
Route::put('companies/{company}/bank-accounts/{bankAccount}', [CompanyBankAccountController::class, 'update']);
Route::delete('companies/{company}/bank-accounts/{bankAccount}', [CompanyBankAccountController::class, 'destroy']);
```

### Новая структура банков и реквизитов
```php
// Управление банками
Route::post('companies/{company}/banks', [CompanyBankController::class, 'store']);
Route::put('companies/{company}/banks/{bank}', [CompanyBankController::class, 'update']);
Route::delete('companies/{company}/banks/{bank}', [CompanyBankController::class, 'destroy']);

// Управление реквизитами банков
Route::post('companies/{company}/banks/{bank}/details', [CompanyBankDetailController::class, 'store']);
Route::put('companies/{company}/bank-details/{detail}', [CompanyBankDetailController::class, 'update']);
Route::delete('companies/{company}/bank-details/{detail}', [CompanyBankDetailController::class, 'destroy']);
```

### Лицензии и доступы
```php
// Обновление данных лицензии (старая структура)
Route::put('companies/{company}/license', [CompanyController::class, 'updateLicense']);

// Управление лицензиями (новая структура - множественные изображения)
Route::post('companies/{company}/licenses', [CompanyLicenseController::class, 'store']);
Route::delete('companies/{company}/licenses/{license}', [CompanyLicenseController::class, 'destroy']);

// Управление доступами
Route::post('companies/{company}/access', [CompanyAccessController::class, 'store']);
Route::delete('companies/{company}/access/{access}', [CompanyAccessController::class, 'destroy']);
```

## Представления

- `admin/companies/index.blade.php` - Список компаний
- `admin/companies/create.blade.php` - Форма создания
- `admin/companies/show.blade.php` - Просмотр с вкладками
- `admin/companies/edit.blade.php` - Редактирование

## Особенности

1. **Загрузка лицензий**: Файлы хранятся в `storage/app/public/licenses/`

2. **Вкладки на странице компании**:
   - **Банки и реквизиты** (новая структура: Банк → Реквизиты + логины/пароли)
   - **Управление доступом** (назначение прав пользователям)

3. **Новая архитектура банков и реквизитов**:
   - Один банк может содержать несколько реквизитов
   - Реквизиты могут быть разных типов: счета, IBAN, SWIFT, данные получателя и т.д.
   - Каждый реквизит может быть отмечен как "основной"
   - Полная иерархия: Компания → Банки → Реквизиты

4. **Интерфейс**:
   - Разворачиваемые/сворачиваемые блоки банков
   - Таблица реквизитов для каждого банка
   - Быстрые действия (добавить, редактировать, удалить)
   - Визуальная иерархия с бейджами и иконками

5. **Валидация**:
   - Все формы валидируются на стороне сервера
   - Валидация типов реквизитов
   - Защита от несанкционированного доступа

6. **Модальные окна**: 
   - Добавление/редактирование банков
   - Добавление/редактирование реквизитов банков
   - Управление доступом пользователей

7. **AJAX-удаление реквизитов**: 
   - Удаление реквизитов происходит без перезагрузки страницы
   - Подтверждение удаления через SweetAlert2 (с fallback на обычный confirm)
   - Автоматическое обновление счетчика реквизитов в заголовке банка
   - Плавная анимация удаления строки из таблицы
   - Автоматическое отображение сообщения, если реквизитов не осталось
   - Обработка ошибок с показом уведомлений (toastr/SweetAlert2/alert)
   - Проверка CSRF токена перед отправкой запроса
   - Блокировка кнопки во время выполнения запроса

8. **Каскадное удаление**: При удалении банка автоматически удаляются все его реквизиты

## Система лицензий

### Новая система множественных лицензий
С версии 2025-11-13 реализована система загрузки и хранения множественных изображений лицензий для каждой компании.

#### Особенности:
1. **Множественная загрузка** - можно загрузить несколько изображений лицензий одновременно
2. **Галерея** - все лицензии отображаются в виде галереи миниатюр
3. **Предпросмотр** - при выборе файлов показывается предпросмотр перед загрузкой
4. **Полноэкранный просмотр** - клик по миниатюре открывает изображение на весь экран
5. **Удаление** - кнопка удаления появляется при наведении на миниатюру
6. **AJAX-удаление** - удаление происходит без перезагрузки страницы
7. **Сортировка** - лицензии автоматически сортируются по порядку добавления

#### Загрузка лицензий
На странице компании (`/admin/companies/{id}`):
1. Нажать кнопку "Загрузить лицензию" или "Загрузить ещё"
2. Выбрать одно или несколько изображений
3. Просмотреть предпросмотр выбранных файлов
4. Нажать "Загрузить"

**Требования к файлам:**
- Формат: JPEG, PNG, JPG, GIF, WEBP
- Максимальный размер: 10 МБ на файл
- Можно загружать несколько файлов одновременно

#### Просмотр лицензий
- Все лицензии отображаются в виде галереи на странице компании
- Миниатюры имеют фиксированную высоту 150px с сохранением пропорций
- При наведении курсора изображение слегка увеличивается (эффект hover)
- Клик по миниатюре открывает модальное окно с полноразмерным изображением
- В модальном окне доступны кнопки:
  - **Закрыть** - закрыть модальное окно
  - **Скачать** - скачать оригинальный файл
  - **Удалить** - удалить лицензию (только для пользователей с правами редактирования)

#### Удаление лицензий
Пользователи с правами редактирования могут удалять лицензии двумя способами:
1. **Через миниатюру** - кнопка удаления появляется при наведении
2. **Через модальное окно** - кнопка "Удалить" в футере модального окна

При удалении:
- Запрашивается подтверждение через SweetAlert2
- Удаление происходит через AJAX без перезагрузки
- Миниатюра исчезает с плавной анимацией
- Файл удаляется из storage
- Показывается уведомление об успешном удалении

#### Хранение файлов
- Файлы хранятся в `storage/app/public/licenses/`
- Каждый файл сохраняется с уникальным именем
- Оригинальное название файла сохраняется в БД для скачивания
- При удалении лицензии файл автоматически удаляется из storage

#### Права доступа
- **Просмотр лицензий** - все пользователи с доступом к компании
- **Загрузка лицензий** - супер-админ, главный модератор, пользователи с правом `edit`
- **Удаление лицензий** - супер-админ, главный модератор, пользователи с правом `edit`

### Обратная совместимость
Старое поле `license_file` в таблице `companies` сохранено для обратной совместимости, но больше не используется. Рекомендуется перенести существующие лицензии в новую систему.

## Изменения (версии)

### 2025-11-13 (Обновление 2)
- **Добавлена система множественных лицензий:**
  - Создана таблица `company_licenses` для хранения множественных изображений
  - Создана модель `CompanyLicense` с связями и методами
  - Создан контроллер `CompanyLicenseController` для управления лицензиями
  - Реализована галерея лицензий на странице компании
  - Добавлена возможность множественной загрузки изображений
  - Реализован предпросмотр файлов перед загрузкой
  - Добавлено модальное окно для полноэкранного просмотра
  - Реализовано AJAX-удаление лицензий с анимацией
  - Добавлены hover-эффекты и стили для галереи
  - Валидация файлов: формат, размер, тип
  - Поддержка форматов: JPEG, PNG, JPG, GIF, WEBP
  - Максимальный размер файла: 10 МБ
  - Автоматическая сортировка лицензий
  - Каскадное удаление лицензий при удалении компании
